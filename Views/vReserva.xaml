<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:KynosPetClub.Controls"
             x:Class="KynosPetClub.Views.vReserva"
             BackgroundColor="White"
             Title="Reservas Activas">
    <Grid RowDefinitions="*,Auto">
        <!-- Contenido principal -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="15">
                <Label Text="Mis Reservas Activas"
                       FontSize="20"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center"/>

                <!-- Indicador de carga -->
                <ActivityIndicator x:Name="loadingIndicator"
                                 IsVisible="False"
                                 IsRunning="False"
                                 Color="#2E7D32"
                                 HeightRequest="50"/>

                <!-- Lista de reservas -->
                <CollectionView x:Name="cvReservas"
                              ItemsSource="{Binding ReservasActivas}"
                              EmptyView="No tienes reservas activas">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame CornerRadius="10" 
                                   HasShadow="True" 
                                   Padding="15"
                                   Margin="0,5,0,5"
                                   BackgroundColor="White">
                                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" 
                                      ColumnDefinitions="Auto,*,Auto"
                                      ColumnSpacing="15"
                                      RowSpacing="8">

                                    <!-- Imagen del servicio -->
                                    <Image Grid.RowSpan="4"
                                           Source="{Binding ImagenServicio}"
                                           HeightRequest="80"
                                           WidthRequest="80"
                                           Aspect="AspectFill"
                                           VerticalOptions="Center"/>

                                    <!-- Estado de la reserva -->
                                    <Frame Grid.Column="2"
                                           BackgroundColor="{Binding ColorEstado}"
                                           CornerRadius="15"
                                           Padding="8,4,8,4"
                                           HasShadow="False">
                                        <Label Text="{Binding Estado}"
                                               TextColor="White"
                                               FontSize="12"
                                               FontAttributes="Bold"
                                               HorizontalTextAlignment="Center"/>
                                    </Frame>

                                    <!-- Información del servicio -->
                                    <Label Grid.Column="1"
                                           Text="{Binding Servicio.Nombre}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="#2E7D32"/>

                                    <Label Grid.Column="1" Grid.Row="1"
                                           Text="{Binding Servicio.Precio, StringFormat='{0:C}'}"
                                           FontSize="16"
                                           TextColor="#4CAF50"
                                           FontAttributes="Bold"/>

                                    <!-- Información de la mascota -->
                                    <Label Grid.Column="1" Grid.Row="2"
                                           Text="{Binding MascotaInfo}"
                                           FontSize="14"
                                           TextColor="#666"/>

                                    <!-- Fecha del servicio -->
                                    <Label Grid.Column="1" Grid.Row="3"
                                           Text="{Binding FechaServicioFormateada}"
                                           FontSize="14"
                                           TextColor="#333"
                                           FontAttributes="Bold"/>

                                    <!-- Botones de acción -->
                                    <StackLayout Grid.ColumnSpan="3" Grid.Row="4"
                                               Orientation="Horizontal"
                                               HorizontalOptions="End"
                                               Spacing="10"
                                               Margin="0,10,0,0">

                                        <Button x:Name="btnVerDetalles"
                                                Text="Ver Detalles"
                                                BackgroundColor="#2196F3"
                                                TextColor="White"
                                                CornerRadius="5"
                                                FontSize="12"
                                                Padding="15,8,15,8"
                                                CommandParameter="{Binding .}"
                                                Clicked="OnVerDetallesClicked"/>

                                        <Button x:Name="btnCancelar"
                                                Text="Cancelar"
                                                BackgroundColor="#F44336"
                                                TextColor="White"
                                                CornerRadius="5"
                                                FontSize="12"
                                                Padding="15,8,15,8"
                                                CommandParameter="{Binding .}"
                                                Clicked="OnCancelarReservaClicked"
                                                IsVisible="{Binding PuedeCancelarse}"/>
                                    </StackLayout>

                                    <!-- Comentarios si existen -->
                                    <Label Grid.ColumnSpan="3" Grid.Row="5"
                                           Text="{Binding Comentarios}"
                                           FontSize="12"
                                           TextColor="#888"
                                           IsVisible="{Binding TieneComentarios}"
                                           Margin="0,5,0,0"/>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Mensaje cuando no hay reservas -->
                <StackLayout x:Name="emptyStateLayout"
                           IsVisible="False"
                           VerticalOptions="CenterAndExpand"
                           Padding="20">
                    <Label Text="📅"
                           FontSize="60"
                           HorizontalTextAlignment="Center"
                           TextColor="#CCC"/>
                    <Label Text="No tienes reservas activas"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalTextAlignment="Center"
                           TextColor="#666"
                           Margin="0,10,0,5"/>
                    <Label Text="Cuando tengas servicios pendientes o en curso, aparecerán aquí"
                           FontSize="14"
                           HorizontalTextAlignment="Center"
                           TextColor="#999"
                           Margin="0,0,0,20"/>
                    <Button Text="Ver Servicios Disponibles"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            CornerRadius="5"
                            Clicked="OnVerServiciosClicked"/>
                </StackLayout>

                <!-- Espaciado adicional -->
                <BoxView HeightRequest="15" Color="Transparent"/>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Barra de navegación inferior -->
        <controls:BottomNavBar x:Name="bottomNavBar" 
                               Grid.Row="1" 
                               Usuario="{Binding Usuario}"/>
    </Grid>
</ContentPage>